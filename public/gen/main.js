(()=>{var e={560:function(e,t,n){var r;!function(a){"use strict";function i(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function o(e,t,n,r,a,o){return i((s=i(i(t,e),i(r,o)))<<(c=a)|s>>>32-c,n);var s,c}function s(e,t,n,r,a,i,s){return o(t&n|~t&r,e,t,a,i,s)}function c(e,t,n,r,a,i,s){return o(t&r|n&~r,e,t,a,i,s)}function u(e,t,n,r,a,i,s){return o(t^n^r,e,t,a,i,s)}function l(e,t,n,r,a,i,s){return o(n^(t|~r),e,t,a,i,s)}function f(e,t){var n,r,a,o,f;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var h=1732584193,d=-271733879,T=-1732584194,p=271733878;for(n=0;n<e.length;n+=16)r=h,a=d,o=T,f=p,h=s(h,d,T,p,e[n],7,-680876936),p=s(p,h,d,T,e[n+1],12,-389564586),T=s(T,p,h,d,e[n+2],17,606105819),d=s(d,T,p,h,e[n+3],22,-1044525330),h=s(h,d,T,p,e[n+4],7,-176418897),p=s(p,h,d,T,e[n+5],12,1200080426),T=s(T,p,h,d,e[n+6],17,-1473231341),d=s(d,T,p,h,e[n+7],22,-45705983),h=s(h,d,T,p,e[n+8],7,1770035416),p=s(p,h,d,T,e[n+9],12,-1958414417),T=s(T,p,h,d,e[n+10],17,-42063),d=s(d,T,p,h,e[n+11],22,-1990404162),h=s(h,d,T,p,e[n+12],7,1804603682),p=s(p,h,d,T,e[n+13],12,-40341101),T=s(T,p,h,d,e[n+14],17,-1502002290),h=c(h,d=s(d,T,p,h,e[n+15],22,1236535329),T,p,e[n+1],5,-165796510),p=c(p,h,d,T,e[n+6],9,-1069501632),T=c(T,p,h,d,e[n+11],14,643717713),d=c(d,T,p,h,e[n],20,-373897302),h=c(h,d,T,p,e[n+5],5,-701558691),p=c(p,h,d,T,e[n+10],9,38016083),T=c(T,p,h,d,e[n+15],14,-660478335),d=c(d,T,p,h,e[n+4],20,-405537848),h=c(h,d,T,p,e[n+9],5,568446438),p=c(p,h,d,T,e[n+14],9,-1019803690),T=c(T,p,h,d,e[n+3],14,-187363961),d=c(d,T,p,h,e[n+8],20,1163531501),h=c(h,d,T,p,e[n+13],5,-1444681467),p=c(p,h,d,T,e[n+2],9,-51403784),T=c(T,p,h,d,e[n+7],14,1735328473),h=u(h,d=c(d,T,p,h,e[n+12],20,-1926607734),T,p,e[n+5],4,-378558),p=u(p,h,d,T,e[n+8],11,-2022574463),T=u(T,p,h,d,e[n+11],16,1839030562),d=u(d,T,p,h,e[n+14],23,-35309556),h=u(h,d,T,p,e[n+1],4,-1530992060),p=u(p,h,d,T,e[n+4],11,1272893353),T=u(T,p,h,d,e[n+7],16,-155497632),d=u(d,T,p,h,e[n+10],23,-1094730640),h=u(h,d,T,p,e[n+13],4,681279174),p=u(p,h,d,T,e[n],11,-358537222),T=u(T,p,h,d,e[n+3],16,-722521979),d=u(d,T,p,h,e[n+6],23,76029189),h=u(h,d,T,p,e[n+9],4,-640364487),p=u(p,h,d,T,e[n+12],11,-421815835),T=u(T,p,h,d,e[n+15],16,530742520),h=l(h,d=u(d,T,p,h,e[n+2],23,-995338651),T,p,e[n],6,-198630844),p=l(p,h,d,T,e[n+7],10,1126891415),T=l(T,p,h,d,e[n+14],15,-1416354905),d=l(d,T,p,h,e[n+5],21,-57434055),h=l(h,d,T,p,e[n+12],6,1700485571),p=l(p,h,d,T,e[n+3],10,-1894986606),T=l(T,p,h,d,e[n+10],15,-1051523),d=l(d,T,p,h,e[n+1],21,-2054922799),h=l(h,d,T,p,e[n+8],6,1873313359),p=l(p,h,d,T,e[n+15],10,-30611744),T=l(T,p,h,d,e[n+6],15,-1560198380),d=l(d,T,p,h,e[n+13],21,1309151649),h=l(h,d,T,p,e[n+4],6,-145523070),p=l(p,h,d,T,e[n+11],10,-1120210379),T=l(T,p,h,d,e[n+2],15,718787259),d=l(d,T,p,h,e[n+9],21,-343485551),h=i(h,r),d=i(d,a),T=i(T,o),p=i(p,f);return[h,d,T,p]}function h(e){var t,n="",r=32*e.length;for(t=0;t<r;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function d(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var r=8*e.length;for(t=0;t<r;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function T(e){var t,n,r="0123456789abcdef",a="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),a+=r.charAt(t>>>4&15)+r.charAt(15&t);return a}function p(e){return unescape(encodeURIComponent(e))}function y(e){return function(e){return h(f(d(e),8*e.length))}(p(e))}function N(e,t){return function(e,t){var n,r,a=d(e),i=[],o=[];for(i[15]=o[15]=void 0,a.length>16&&(a=f(a,8*e.length)),n=0;n<16;n+=1)i[n]=909522486^a[n],o[n]=1549556828^a[n];return r=f(i.concat(d(t)),512+8*t.length),h(f(o.concat(r),640))}(p(e),p(t))}function g(e,t,n){return t?n?N(t,e):T(N(t,e)):n?y(e):T(y(e))}void 0===(r=function(){return g}.call(t,n,t,e))||(e.exports=r)}()},770:function(e){e.exports=(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{StreamDataView:()=>a});var n=function(){function e(e){this.encoding=e||"utf-8"}return e.prototype.decode=function(e){var t=String.fromCharCode.apply(null,Array.from(e));return"utf-8"===this.encoding?decodeURIComponent(escape(t)):t},e}(),r=function(){function e(e){this.encoding=e||"utf-8"}return e.prototype.encode=function(e){return"utf-8"===this.encoding&&(e=unescape(encodeURIComponent(e))),new Uint8Array(e.split("").map((function(e){return e.charCodeAt(0)})))},e}(),a=function(){function e(e,t){this.offset=0,this.autoResize=!1,void 0===e&&(e=0,this.autoResize=!0),"number"==typeof e&&(e=new ArrayBuffer(e)),this.view=new DataView(e),this.littleEndian=!t}return e.fromByteString=function(t){var n=new e(t.split(" ").length);return n.fromByteString(t),n},e.fromTextString=function(t,n){var a,i=new e((a=n?new r("utf-8").encode(t):new r("ascii").encode(t)).length);return i.setNextString(t,n,a.length),i},e.prototype.resize=function(e){var t=function(e,t){if(!(e instanceof ArrayBuffer))throw new TypeError("Source must be an instance of ArrayBuffer");if(t<=e.byteLength)return e.slice(0,t);var n=new Uint8Array(e),r=new Uint8Array(new ArrayBuffer(t));return r.set(n),r.buffer}(this.getBuffer(),e);this.view=new DataView(t)},e.prototype.crop=function(){this.resize(this.getOffset())},e.prototype.getBuffer=function(){return this.view.buffer},e.prototype.skip=function(e){this.offset+=e},e.prototype.resetOffset=function(){this.offset=0},e.prototype.getOffset=function(){return this.offset},e.prototype.setOffset=function(e){this.offset=e},e.prototype.getInt8=function(e){return this.view.getInt8(e)},e.prototype.getUint8=function(e){return this.view.getUint8(e)},e.prototype.getNextInt8=function(){var e=this.getInt8(this.offset);return this.offset+=1,e},e.prototype.getNextUint8=function(){var e=this.getUint8(this.offset);return this.offset+=1,e},e.prototype.getInt16=function(e){return this.view.getInt16(e,this.littleEndian)},e.prototype.getUint16=function(e){return this.view.getUint16(e,this.littleEndian)},e.prototype.getNextInt16=function(){var e=this.getInt16(this.offset);return this.offset+=2,e},e.prototype.getNextUint16=function(){var e=this.getUint16(this.offset);return this.offset+=2,e},e.prototype.getInt32=function(e){return this.view.getInt32(e,this.littleEndian)},e.prototype.getUint32=function(e){return this.view.getUint32(e,this.littleEndian)},e.prototype.getNextInt32=function(){var e=this.getInt32(this.offset);return this.offset+=4,e},e.prototype.getNextUint32=function(){var e=this.getUint32(this.offset);return this.offset+=4,e},e.prototype.getFloat32=function(e){return this.view.getFloat32(e,this.littleEndian)},e.prototype.getFloat64=function(e){return this.view.getFloat64(e,this.littleEndian)},e.prototype.getNextFloat32=function(){var e=this.getFloat32(this.offset);return this.offset+=4,e},e.prototype.getNextFloat64=function(){var e=this.getFloat64(this.offset);return this.offset+=8,e},e.prototype.setInt8=function(e,t){this.handleAutoResize(e,1),this.view.setInt8(e,t)},e.prototype.setUint8=function(e,t){this.handleAutoResize(e,1),this.view.setUint8(e,t)},e.prototype.setNextInt8=function(e){this.setInt8(this.offset,e),this.offset+=1},e.prototype.setNextUint8=function(e){this.setUint8(this.offset,e),this.offset+=1},e.prototype.setInt16=function(e,t){this.handleAutoResize(e,2),this.view.setInt16(e,t,this.littleEndian)},e.prototype.setUint16=function(e,t){this.handleAutoResize(e,2),this.view.setUint16(e,t,this.littleEndian)},e.prototype.setNextInt16=function(e){this.setInt16(this.offset,e),this.offset+=2},e.prototype.setNextUint16=function(e){this.setUint16(this.offset,e),this.offset+=2},e.prototype.setInt32=function(e,t){this.handleAutoResize(e,4),this.view.setInt32(e,t,this.littleEndian)},e.prototype.setUint32=function(e,t){this.handleAutoResize(e,4),this.view.setUint32(e,t,this.littleEndian)},e.prototype.setNextInt32=function(e){this.setInt32(this.offset,e),this.offset+=4},e.prototype.setNextUint32=function(e){this.setUint32(this.offset,e),this.offset+=4},e.prototype.setFloat32=function(e,t){this.handleAutoResize(e,8),this.view.setFloat32(e,t,this.littleEndian)},e.prototype.setFloat64=function(e,t){this.handleAutoResize(e,8),this.view.setFloat64(e,t,this.littleEndian)},e.prototype.setNextFloat32=function(e){this.setFloat32(this.offset,e),this.offset+=4},e.prototype.setNextFloat64=function(e){this.setFloat64(this.offset,e),this.offset+=8},e.prototype.getBytes=function(e,t){void 0===e&&(e=0),t=t||this.view.buffer.byteLength-e;var n=this.getBuffer().slice(e,e+t);return new Uint8Array(n)},e.prototype.getNextBytes=function(e){var t=this.getBytes(this.offset,e);return this.offset+=e||0,t},e.prototype.setBytes=function(e,t){(t instanceof ArrayBuffer||Array.isArray(t))&&(t=new Uint8Array(t));var n=t;this.handleAutoResize(e,n.byteLength);for(var r=0;r<n.byteLength;r++)this.setUint8(e+r,n[r])},e.prototype.setNextBytes=function(e){Array.isArray(e)&&(e=new Uint8Array(e)),this.setBytes(this.offset,e),this.offset+=e.byteLength},e.prototype.getString=function(e,t,r,a){var i=this.getBytes(e,t);if(a){var o=i.indexOf(0);o>=0&&(i=i.slice(0,o))}return r?new n("utf-8").decode(i):new n("ascii").decode(i)},e.prototype.getNextString=function(e,t,n){var r=this.getString(this.offset,e,t,n);return this.offset+=e,r},e.prototype.setString=function(e,t,n,a){var i;i=n?new r("utf-8").encode(t):new r("ascii").encode(t),a="number"==typeof a?a:i.byteLength,this.handleAutoResize(e,a);for(var o=0;o<a;o++)this.view.setUint8(e+o,i[o]||0);return a},e.prototype.setNextString=function(e,t,n){this.offset+=this.setString(this.offset,e,t,n)},e.prototype.toByteString=function(){return Array.from(new Uint8Array(this.getBuffer())).map((function(e){return("00"+e.toString(16)).slice(-2)})).join(" ").toUpperCase()},e.prototype.toTextString=function(e){return this.getString(0,this.view.byteLength,e)},e.prototype.fromByteString=function(e){var t=e.split(" "),n=new ArrayBuffer(t.length);this.view=new DataView(n),this.setNextBytes(new Uint8Array(t.map((function(e){return parseInt(e,16)})))),this.resetOffset()},e.prototype.getLength=function(){return this.view.byteLength},e.prototype.clear=function(){this.view=new DataView(new ArrayBuffer(this.view.byteLength)),this.offset=0},e.prototype.handleAutoResize=function(e,t){this.autoResize&&this.getBuffer().byteLength<e+t&&this.resize(e+t)},e}();return t})()}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";class e{load(e){return t=this,n=void 0,a=function*(){const t=yield fetch(e);return"json"===function(e){return e.split(".").pop()}(e)?yield t.json():yield t.text()},new((r=void 0)||(r=Promise))((function(e,i){function o(e){try{c(a.next(e))}catch(e){i(e)}}function s(e){try{c(a.throw(e))}catch(e){i(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(o,s)}c((a=a.apply(t,n||[])).next())}));var t,n,r,a}}var t,r,a=n(770);!function(e){e[e.LEAF=0]="LEAF",e[e.ARRAY=1]="ARRAY",e[e.OBJECT=2]="OBJECT",e[e.SPLIT=3]="SPLIT"}(t||(t={})),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.NULL=1]="NULL",e[e.BOOLEAN_FALSE=2]="BOOLEAN_FALSE",e[e.BOOLEAN_TRUE=3]="BOOLEAN_TRUE",e[e.INT8=4]="INT8",e[e.UINT8=5]="UINT8",e[e.INT16=6]="INT16",e[e.UINT16=7]="UINT16",e[e.INT32=8]="INT32",e[e.UINT32=9]="UINT32",e[e.FLOAT32=10]="FLOAT32",e[e.FLOAT64=11]="FLOAT64",e[e.STRING=12]="STRING",e[e.UNICODE=13]="UNICODE",e[e.OBJECT_8=17]="OBJECT_8",e[e.OBJECT_16=18]="OBJECT_16",e[e.OBJECT_32=19]="OBJECT_32",e[e.SPLIT_8=20]="SPLIT_8",e[e.SPLIT_16=21]="SPLIT_16",e[e.SPLIT_32=22]="SPLIT_32",e[e.ARRAY_8=23]="ARRAY_8",e[e.ARRAY_16=24]="ARRAY_16",e[e.ARRAY_32=25]="ARRAY_32",e[e.OFFSET_ARRAY_8=26]="OFFSET_ARRAY_8",e[e.OFFSET_ARRAY_16=27]="OFFSET_ARRAY_16",e[e.OFFSET_ARRAY_32=28]="OFFSET_ARRAY_32",e[e.EMPTY_ARRAY=29]="EMPTY_ARRAY",e[e.REFERENCE_8=30]="REFERENCE_8",e[e.REFERENCE_16=31]="REFERENCE_16",e[e.REFERENCE_32=32]="REFERENCE_32",e[e.COMPLEX_OBJECT=33]="COMPLEX_OBJECT",e[e.UINT2=34]="UINT2",e[e.UINT4=35]="UINT4",e[e.STRING2=36]="STRING2",e[e.STRING4=37]="STRING4"}(r||(r={}));const i=[r.UINT8,r.INT8,r.UINT16,r.INT16,r.UINT32,r.INT32,r.FLOAT32,r.FLOAT64];class o{constructor(e){this.allowSet=e}numberSatisfyDataType(e,t){if(e%1!=0)switch(t){case r.FLOAT32:return Math.fround(e)===e;case r.FLOAT64:return!0;default:return!1}switch(t){case r.UINT8:return e>=0&&e<=255;case r.INT8:return e>=-128&&e<=127;case r.UINT16:return e>=0&&e<=65535;case r.INT16:return e>=-32768&&e<=32767;case r.UINT32:return e>=0;case r.INT32:return!0}return!1}getBestType(e){if(e.some((e=>e%1!=0)))return e.every((e=>this.numberSatisfyDataType(e,r.FLOAT32)))?r.FLOAT32:r.FLOAT64;const t=Math.min(...e),n=Math.max(...e);for(let e of i)if(this.numberSatisfyDataType(t,e)&&this.numberSatisfyDataType(n,e))return e;return r.FLOAT64}getNumberDataType(e){for(let t of i)if(this.numberSatisfyDataType(e,t))return t;return r.UNDEFINED}getStringDataType(e,t=!1){const n=e.split("").map((e=>e.charCodeAt(0)));if(!t&&this.allowSet){const e=new Set(n);if(e.size<n.length/3&&e.size<=16)return e.size<=4?r.STRING2:r.STRING4}return n.every((e=>e<=255))?r.STRING:r.UNICODE}getFullTokenDataType(e){switch(e.type){case"array":return r.ARRAY_8;case"object":return r.OBJECT_8;case"split":return r.SPLIT_8;default:return this.getDataType(e)}}getDataType(e){switch(e.type){case"complex":return r.COMPLEX_OBJECT;case"array":case"object":case"split":let t=e.value;if(!t.length)return console.assert("array"===e.type),r.EMPTY_ARRAY;let n=0;if("array"===e.type&&t.length>3){const e=Math.min(...t),r=Math.max(...t);this.getNumberDataType(r-e)!==this.getNumberDataType(r)&&(n=e),t=t.map((e=>e-n))}const a=this.getBestType(t);switch(e.type){case"object":return a===r.UINT8?r.OBJECT_8:a===r.UINT16?r.OBJECT_16:r.OBJECT_32;case"split":return a===r.UINT8?r.SPLIT_8:a===r.UINT16?r.SPLIT_16:r.SPLIT_32;case"array":return n?a===r.UINT8?r.OFFSET_ARRAY_8:a===r.UINT16?r.OFFSET_ARRAY_16:r.OFFSET_ARRAY_32:a===r.UINT8?r.ARRAY_8:a===r.UINT16?r.ARRAY_16:r.ARRAY_32}case"leaf":if(void 0===e.value)return r.UNDEFINED;if(null===e.value)return r.NULL;switch(typeof e.value){case"boolean":return e.value?r.BOOLEAN_TRUE:r.BOOLEAN_FALSE;case"string":return this.getStringDataType(e.value);case"number":return this.getNumberDataType(e.value)}break;case"reference":switch(this.getNumberDataType(e.value)){case r.UINT8:return r.REFERENCE_8;case r.UINT16:return r.REFERENCE_16;case r.UINT32:return r.REFERENCE_32}throw new Error("Invalid reference value: "+e.value)}throw new Error(`Unrecognized type for ${e.type} value: ${e.value}`)}dataTypeToType(e){switch(e){case r.COMPLEX_OBJECT:return"complex";case r.EMPTY_ARRAY:case r.ARRAY_8:case r.ARRAY_16:case r.ARRAY_32:return"array";case r.OBJECT_8:case r.OBJECT_16:case r.OBJECT_32:return"object";case r.SPLIT_8:case r.SPLIT_16:case r.SPLIT_32:return"split";case r.REFERENCE_8:case r.REFERENCE_16:case r.REFERENCE_32:return"reference";default:return"leaf"}}typeToStructureType(e){switch(e){case"leaf":return t.LEAF;case"array":return t.ARRAY;case"object":return t.OBJECT;case"split":return t.SPLIT}throw new Error("Cannot translate to structure type: "+e)}}class s{constructor(e,t){this.streamDataView=e,this.dataTypeUtils=new o(t)}encodeTokens(e,t){let n=0;for(;n<e.length;){const r=this.encodeMulti(e,n,t);r&&(n+=r)}this.encodeMulti([],n,t)}decodeTokens(e){const t=[];for(;this.streamDataView.getOffset()<this.streamDataView.getLength()&&this.decodeMulti(t,e););return t}encodeToken(e,t,n){const a=null!=t?t:this.encodeDataType(this.dataTypeUtils.getDataType(e));switch(a){case r.UNDEFINED:case r.NULL:case r.BOOLEAN_TRUE:case r.BOOLEAN_FALSE:case r.EMPTY_ARRAY:break;case r.INT8:case r.UINT8:case r.INT16:case r.UINT16:case r.INT32:case r.UINT32:case r.FLOAT32:case r.FLOAT64:this.encodeSingleNumber(e.value,a);break;case r.STRING2:case r.STRING4:case r.STRING:case r.UNICODE:this.encodeString(e.value,a,n);break;case r.OBJECT_8:case r.OBJECT_16:case r.OBJECT_32:this.encodeObjectToken(e,a);break;case r.SPLIT_8:case r.SPLIT_16:case r.SPLIT_32:this.encodeSplitToken(e,a);break;case r.ARRAY_8:case r.ARRAY_16:case r.ARRAY_32:case r.OFFSET_ARRAY_8:case r.OFFSET_ARRAY_16:case r.OFFSET_ARRAY_32:this.encodeArrayToken(e,a);break;case r.REFERENCE_8:case r.REFERENCE_16:case r.REFERENCE_32:this.encodeReferenceToken(e,a);break;case r.COMPLEX_OBJECT:this.encodeComplexToken(e,a);break;default:throw new Error("Invalid dataType: "+a)}}decodeToken(e,t){const n=null!=e?e:this.decodeDataType();switch(n){case r.UNDEFINED:return{type:"leaf",value:void 0};case r.NULL:return{type:"leaf",value:null};case r.BOOLEAN_TRUE:return{type:"leaf",value:!0};case r.BOOLEAN_FALSE:return{type:"leaf",value:!1};case r.EMPTY_ARRAY:return{type:"array",value:[]};case r.UINT2:case r.UINT4:throw new Error("Use decode number array.");case r.INT8:case r.UINT8:case r.INT16:case r.UINT16:case r.INT32:case r.UINT32:case r.FLOAT32:case r.FLOAT64:return{type:"leaf",value:this.decodeSingleNumber(n)};case r.STRING2:case r.STRING4:case r.STRING:case r.UNICODE:return{type:"leaf",value:this.decodeString(n,t)};case r.OBJECT_8:case r.OBJECT_16:case r.OBJECT_32:return this.decodeObjectToken(n);case r.SPLIT_8:case r.SPLIT_16:case r.SPLIT_32:return this.decodeSplitToken(n);case r.ARRAY_8:case r.ARRAY_16:case r.ARRAY_32:case r.OFFSET_ARRAY_8:case r.OFFSET_ARRAY_16:case r.OFFSET_ARRAY_32:return this.decodeArrayToken(n);case r.REFERENCE_8:case r.REFERENCE_16:case r.REFERENCE_32:return this.decodeReferenceToken(n);case r.COMPLEX_OBJECT:return this.decodeComplexToken(n);default:throw new Error("Invalid dataType: "+n)}}isOffsetDataType(e){return e===r.OFFSET_ARRAY_8||e===r.OFFSET_ARRAY_16||e===r.OFFSET_ARRAY_32}encodeArrayToken(e,t){const n=null!=t?t:this.encodeDataType(this.dataTypeUtils.getDataType(e)),a=n===r.ARRAY_8||n===r.OFFSET_ARRAY_8?r.UINT8:n===r.ARRAY_16||n===r.OFFSET_ARRAY_16?r.UINT16:r.UINT32;let i=e.value;if(this.isOffsetDataType(n)){const e=Math.min(...i);i=i.map((t=>t-e)),this.encodeSingleNumber(e)}this.encodeNumberArray(i,a)}decodeArrayToken(e){const t=null!=e?e:this.decodeDataType();let n=0;this.isOffsetDataType(t)&&(n=this.decodeSingleNumber());const a=t===r.ARRAY_8||t===r.OFFSET_ARRAY_8?r.UINT8:t===r.ARRAY_16||t===r.OFFSET_ARRAY_16?r.UINT16:r.UINT32;return{type:"array",value:this.decodeNumberArray(a).map((e=>e+n))}}encodeObjectToken(e,t){const n=null!=t?t:this.encodeDataType(this.dataTypeUtils.getDataType(e)),a=n===r.OBJECT_8?r.UINT8:n===r.OBJECT_16?r.UINT16:r.UINT32,[i,o]=e.value;this.encodeSingleNumber(i,a),this.encodeSingleNumber(o,a)}decodeObjectToken(e){const t=null!=e?e:this.decodeDataType(),n=t===r.OBJECT_8?r.UINT8:t===r.OBJECT_16?r.UINT16:r.UINT32;return{type:"object",value:[this.decodeSingleNumber(n),this.decodeSingleNumber(n)]}}encodeSplitToken(e,t){const n=null!=t?t:this.encodeDataType(this.dataTypeUtils.getDataType(e)),a=n===r.SPLIT_8?r.UINT8:n===r.SPLIT_16?r.UINT16:r.UINT32,[i,o]=e.value;this.encodeSingleNumber(i,a),this.encodeSingleNumber(o,a)}decodeSplitToken(e){const t=null!=e?e:this.decodeDataType(),n=t===r.SPLIT_8?r.UINT8:t===r.SPLIT_16?r.UINT16:r.UINT32;return{type:"split",value:[this.decodeSingleNumber(n),this.decodeSingleNumber(n)]}}encodeReferenceToken(e,t){const n=null!=t?t:this.encodeDataType(this.dataTypeUtils.getDataType(e)),a=n===r.REFERENCE_8?r.UINT8:n===r.REFERENCE_16?r.UINT16:r.UINT32,i=e.value;this.encodeSingleNumber(i,a)}decodeReferenceToken(e){const t=null!=e?e:this.decodeDataType(),n=t===r.REFERENCE_8?r.UINT8:t===r.REFERENCE_16?r.UINT16:r.UINT32;return{type:"reference",value:this.decodeSingleNumber(n)}}encodeComplexToken(e,t){void 0===t&&this.encodeDataType(this.dataTypeUtils.getDataType(e));const n=e.value;this.encodeNumberArray(n,r.UINT2)}decodeComplexToken(e){const t=null!=e?e:this.decodeDataType(),n=this.decodeNumberArray(r.UINT2);return{type:this.dataTypeUtils.dataTypeToType(t),value:n}}encodeDataType(e){return this.streamDataView.setNextUint8(e),e}decodeDataType(){return this.streamDataView.getNextUint8()}encodeMulti(e,t,n){if(t>=e.length)return this.encodeSingleNumber(0,r.UINT8),0;const a=this.dataTypeUtils.getDataType(e[t]);let i;const o=Math.min(e.length-t,255);for(i=1;i<o&&this.dataTypeUtils.getDataType(e[t+i])===a;i++);this.encodeSingleNumber(i,r.UINT8),this.encodeDataType(a);const s={organized:n};for(let n=0;n<i;n++)this.encodeToken(e[t+n],a,s);return i}decodeMulti(e,t){const n=this.streamDataView.getNextUint8();if(!n)return 0;const r=this.decodeDataType(),a={organized:t};for(let t=0;t<n;t++){const t=this.decodeToken(r,a);e.push(t)}return n}encodeSingleNumber(e,t){const n=null!=t?t:this.encodeDataType(this.dataTypeUtils.getNumberDataType(e));switch(n){case r.UINT2:case r.UINT4:throw new Error("Use encode number array.");case r.UINT8:this.streamDataView.setNextUint8(e);break;case r.INT8:this.streamDataView.setNextInt8(e);break;case r.UINT16:this.streamDataView.setNextUint16(e);break;case r.INT16:this.streamDataView.setNextInt16(e);break;case r.UINT32:this.streamDataView.setNextUint32(e);break;case r.INT32:this.streamDataView.setNextInt32(e);break;case r.FLOAT32:this.streamDataView.setNextFloat32(e);break;case r.FLOAT64:this.streamDataView.setNextFloat64(e);break;default:throw new Error("Invalid dataType for number: "+n)}}decodeSingleNumber(e){const t=null!=e?e:this.decodeDataType();switch(t){case r.UINT2:case r.UINT4:throw new Error("Use decode number array.");case r.UINT8:return this.streamDataView.getNextUint8();case r.INT8:return this.streamDataView.getNextInt8();case r.UINT16:return this.streamDataView.getNextUint16();case r.INT16:return this.streamDataView.getNextInt16();case r.UINT32:return this.streamDataView.getNextUint32();case r.INT32:return this.streamDataView.getNextInt32();case r.FLOAT32:return this.streamDataView.getNextFloat32();case r.FLOAT64:return this.streamDataView.getNextFloat64();default:throw new Error("Invalid dataType for number: "+t)}}bit2ToNum([e,t,n,r]){return(null!=e?e:0)<<0|(null!=t?t:0)<<2|(null!=n?n:0)<<4|(null!=r?r:0)<<6}numToBit2(e,t=4){return[e>>0&3,e>>2&3,e>>4&3,e>>6&3].slice(0,t)}bit4ToNum([e,t]){return(null!=e?e:0)<<0|(null!=t?t:0)<<4}numToBit4(e,t=2){return[e>>0&15,e>>4&15].slice(0,t)}encodeNumberArray(e,t){if(t===r.UINT2||t===r.UINT4){const n=t===r.UINT2?4:2,a=t===r.UINT2?this.bit2ToNum:this.bit4ToNum,i=[];for(let t=0;t<e.length;t+=n)i.push(a(e.slice(t,t+n)));return this.encodeNumberArray(i,r.UINT8),void this.encodeSingleNumber(e.length-i.length*n,r.INT8)}let n;for(n=0;n<e.length;){const a=Math.min(255,e.length-n);if(this.encodeSingleNumber(a,r.UINT8),!a)break;const i=null!=t?t:this.encodeDataType(this.dataTypeUtils.getBestType(e));for(let t=0;t<a;t++)this.encodeSingleNumber(e[n+t],i);n+=a}255===n&&this.encodeSingleNumber(0,r.UINT8)}decodeNumberArray(e){if(e===r.UINT2||e===r.UINT4){const t=e===r.UINT2?this.numToBit2:this.numToBit4,n=[],a=this.decodeNumberArray(r.UINT8);for(let e of a)n.push(...t(e));const i=this.decodeSingleNumber(r.INT8);return n.length+=i,n}let t;const n=[];do{if(t=this.decodeSingleNumber(r.UINT8),!t)break;const a=null!=e?e:this.decodeDataType();for(let e=0;e<t;e++)n.push(this.decodeSingleNumber(a))}while(t>=255);return n}encodeString(e,t,n,a=!1){const i=null!=t?t:this.encodeDataType(this.dataTypeUtils.getStringDataType(e,a));if(i===r.STRING2||i===r.STRING4){const t=new Set(e.split("")),a=Array.from(t).sort();return this.encodeString(a.join(""),void 0,n,!0),void this.encodeNumberArray(e.split("").map((e=>a.indexOf(e))),a.length<=4?r.UINT2:r.UINT4)}const o=e.split("").map((e=>e.charCodeAt(0)));(null==n?void 0:n.organized)&&n.lastStringLength===e.length||o.push(0);const s=i===r.STRING?r.UINT8:r.UINT16;o.forEach((e=>this.encodeSingleNumber(e,s))),n&&(n.lastStringLength=e.length)}decodeString(e,t){const n=null!=e?e:this.decodeDataType();if(n===r.STRING2||n===r.STRING4){const e=this.decodeString(void 0,t).split("");return this.decodeNumberArray(e.length<=4?r.UINT2:r.UINT4).map((t=>e[t])).join("")}const a=[],i=n===r.STRING?r.UINT8:r.UINT16;for(;;){const e=this.decodeSingleNumber(i);if(!e)break;if(a.push(e),(null==t?void 0:t.organized)&&(null==t?void 0:t.lastStringLength)&&a.length>=(null==t?void 0:t.lastStringLength))break}const o=a.map((e=>String.fromCharCode(e))).join("");return t&&(t.lastStringLength=o.length),o}static selfTest(){[(e,t,n)=>{this.testAction(r.STRING,(t=>e.encodeDataType(t)),n,(()=>t.decodeDataType()))},(e,t,n)=>{this.testAction(r.UNDEFINED,(t=>e.encodeDataType(t)),n,(()=>t.decodeDataType()))},(e,t,n)=>{this.testAction(33,(t=>e.encodeSingleNumber(t,r.INT8)),n,(()=>t.decodeSingleNumber(r.INT8)))},(e,t,n)=>{this.testAction([{type:"leaf",value:123},{type:"leaf",value:45},{type:"leaf",value:67},{type:"leaf",value:89}],(t=>e.encodeMulti(t,0,!1)),n,(()=>{const e=[];return t.decodeMulti(e,!1),e}))},(e,t,n)=>{this.testAction([{type:"leaf",value:1000001},{type:"leaf",value:1002e3},{type:"leaf",value:1003001}],(t=>e.encodeMulti(t,0,!1)),n,(()=>{const e=[];return t.decodeMulti(e,!1),e}))},(e,t,n)=>{this.testAction([1,2,3,4,10,20,200],(t=>e.encodeNumberArray(t)),n,(()=>t.decodeNumberArray()))},(e,t,n)=>{this.testAction(new Array(2e3).fill(null).map(((e,t)=>t)),(t=>e.encodeNumberArray(t)),n,(()=>t.decodeNumberArray()))},(e,t,n)=>{this.testAction([1e4,-202,3,4,10,20,3200],(t=>e.encodeNumberArray(t)),n,(()=>t.decodeNumberArray()))},(e,t,n)=>{this.testAction("teststring",(t=>e.encodeString(t)),n,(()=>t.decodeString()))},(e,t,n)=>{this.testAction("teststring",(t=>e.encodeString(t,r.STRING)),n,(()=>t.decodeString(r.STRING)))},(e,t,n)=>{this.testAction("testðŸ˜€ðŸ˜ƒðŸ˜„ðŸ˜ðŸ˜†",(t=>e.encodeString(t)),n,(()=>t.decodeString()))},(e,t,n)=>{this.testAction({type:"object",value:[200,201]},(t=>e.encodeObjectToken(t)),n,(()=>t.decodeObjectToken()))},(e,t,n)=>{this.testAction({type:"object",value:[2e3,2001]},(t=>e.encodeObjectToken(t)),n,(()=>t.decodeObjectToken()))},(e,t,n)=>{this.testAction({type:"object",value:[2e3,2001]},(t=>e.encodeObjectToken(t,r.OBJECT_32)),n,(()=>t.decodeObjectToken(r.OBJECT_32)))},(e,t,n)=>{this.testAction({type:"split",value:[200,201]},(t=>e.encodeSplitToken(t)),n,(()=>t.decodeSplitToken()))},(e,t,n)=>{this.testAction({type:"split",value:[2e3,2001]},(t=>e.encodeSplitToken(t)),n,(()=>t.decodeSplitToken()))},(e,t,n)=>{this.testAction({type:"split",value:[2e3,2001]},(t=>e.encodeSplitToken(t,r.SPLIT_32)),n,(()=>t.decodeSplitToken(r.SPLIT_32)))},(e,t,n)=>{this.testAction({type:"leaf",value:"tokenstring"},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction({type:"leaf",value:123.5},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction({type:"leaf",value:"ðŸ˜ðŸ˜†"},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction({type:"array",value:[1,10,20,30,200]},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction({type:"array",value:[1001,1010,1020,1030,1200]},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction({type:"array",value:[10010,10100,10300,2e4]},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction({type:"array",value:[10010,10100,1e4]},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction({type:"array",value:new Array(260).fill(null).map(((e,t)=>t))},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction(new Array(100).fill(null).map(((e,t)=>({type:"array",value:new Array(t).fill(null).map(((e,t)=>t))}))),(t=>e.encodeTokens(t,!1)),n,(()=>t.decodeTokens(!1)))},(e,t,n)=>{this.testAction(new Array(260).fill(null).map(((e,t)=>({type:"array",value:new Array(t).fill(null).map(((e,t)=>t))}))),(t=>e.encodeTokens(t,!1)),n,(()=>t.decodeTokens(!1)))},(e,t,n)=>{this.testAction(new Array(260).fill(null).map(((e,t)=>({type:"array",value:[1]}))),(t=>e.encodeTokens(t,!1)),n,(()=>t.decodeTokens(!1)))},(e,t,n)=>{this.testAction({type:"complex",value:[1,2,3,2,1,2,1,0]},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction({type:"complex",value:"120100310000000310000000031000003100003100000031000000031000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000031000000000010000000120103100020103100020103100031000000000002010031000000031000000003100000310000310000003100000003100000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000310000000000100000001201031000201031000201031000310000000000020100310000000310000000031000003100003100000031000000031000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000003100000000001000000012010310002010310002010310003100000000000201003100000003100000000310000031000031000000310000000031000000000000000000000000000100000000000000000000000000310000000000100000001201031000201031000201031000310000000000020100310000000310000000031000003100003100000031000000031000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000003100000000001000000012010310002010310002010310003100000000000".split("").map((e=>parseInt(e)))},(t=>e.encodeToken(t)),n,(()=>t.decodeToken()))},(e,t,n)=>{this.testAction([1,2,3,2,1,2,1,0],(t=>e.encodeNumberArray(t,r.UINT2)),n,(()=>t.decodeNumberArray(r.UINT2)))},(e,t,n)=>{this.testAction([1,15,12,12,1,9,1,0],(t=>e.encodeNumberArray(t,r.UINT4)),n,(()=>t.decodeNumberArray(r.UINT4)))},(e,t,n)=>{this.testAction("xyzxyzyzxxxyyyzzz",(t=>e.encodeString(t)),n,(()=>t.decodeString()))},(e,t,n)=>{this.testAction("abcdeabcabcadbdddba",(t=>e.encodeString(t)),n,(()=>t.decodeString()))}].forEach(((e,t)=>{const n=new a.StreamDataView;e(new s(n,!0),new s(n,!0),(()=>n.resetOffset())),console.info(`âœ… Passed test ${t}.`)}))}static testAction(e,t,n,r,a=((e,t)=>console.assert(JSON.stringify(e)===JSON.stringify(t),"Not equal: \n%s\n!==\n%s (expected)",JSON.stringify(e),JSON.stringify(t)))){t(e),n();const i=r();n(),a(i,e)}}class c{constructor(e){this.dataTypeUtils=new o(e)}reduce(e){const t={},n=this.createReducedHeaderTokens(this.filterSplit(Object.values(e.registry).filter((e=>e.files.size>1||e.files.has("header"))),e.registry),t),r=Object.entries(e.files).sort((([e],[t])=>e.localeCompare(t))),a=r.map((([,e])=>t[e.nameToken.hash])),i=r.map((([,{token:r}])=>{const a=Object.assign({},t),i=[],o=[{type:"complex",value:i}];return this.createComplexObject(r,a,e.registry,n,i,o),o}));return{originalDataSize:e.originalDataSize,headerTokens:n,files:a,getDataTokens:e=>i[e]}}sortTokens(e){e.sort(((e,t)=>t.count-e.count))}organizeTokens(e){if(!e.length)return e;const t=[];e.forEach((e=>{const n=this.dataTypeUtils.getFullTokenDataType(e);let r;for(let e of t)if(e.length<255&&this.dataTypeUtils.getFullTokenDataType(e[0])===n){r=e;break}r||(r=[],t.push(r)),r.push(e)})),t.forEach((e=>{switch(this.dataTypeUtils.getFullTokenDataType(e[0])){case r.UINT8:case r.UINT16:case r.UINT32:case r.INT8:case r.INT16:case r.INT32:case r.FLOAT32:case r.FLOAT64:e.sort(((e,t)=>t.value-e.value));break;case r.STRING2:case r.STRING4:e.sort(((e,t)=>new Set(t.value.split("")).size-new Set(e.value.split("")).size));break;case r.STRING:case r.UNICODE:case r.ARRAY_8:case r.ARRAY_16:case r.ARRAY_32:e.sort(((e,t)=>t.value.length-e.value.length))}}));const n=[];return t.forEach((e=>e.forEach((e=>n.push(e))))),n}filterSplit(e,t){for(let n of e)if("split"===n.type){const[e,r]=n.reference,a=t[e],i=t[r];a.count<=n.count&&i.count<=n.count&&(a.deleted=!0,i.deleted=!0,n.type="leaf",delete n.reference)}return e.filter((({deleted:e})=>!e))}createReducedHeaderTokens(e,t,n=0){this.sortTokens(e);const r=this.organizeTokens(e);return r.forEach((({hash:e},r)=>t[e]=r+n)),r.map((e=>{var n,r;return{type:e.type,value:null!==(r=null===(n=e.reference)||void 0===n?void 0:n.map((e=>t[e])))&&void 0!==r?r:e.value}}))}createComplexObject(e,n,r,a,i,o){var s,c;if(n[e.hash]>=0)i.push(t.LEAF),o.push({type:"reference",value:n[e.hash]});else if("leaf"===e.type)i.push(this.dataTypeUtils.typeToStructureType(e.type)),n[e.hash]=a.length+o.length,o.push({type:e.type,value:e.value});else{if("split"!==e.type&&"object"!==e.type&&"array"!==e.type)throw new Error("Invalid token type");{i.push(this.dataTypeUtils.typeToStructureType(e.type)),"array"===e.type&&o.push({type:"leaf",value:null===(s=e.reference)||void 0===s?void 0:s.length});const t=null===(c=e.reference)||void 0===c?void 0:c.map((e=>r[e]));null==t||t.forEach((e=>{this.createComplexObject(e,n,r,a,i,o)}))}}}}var u=Uint8Array,l=Uint16Array,f=Uint32Array,h=new u([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),d=new u([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),T=new u([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),p=function(e,t){for(var n=new l(31),r=0;r<31;++r)n[r]=t+=1<<e[r-1];var a=new f(n[30]);for(r=1;r<30;++r)for(var i=n[r];i<n[r+1];++i)a[i]=i-n[r]<<5|r;return[n,a]},y=p(h,2),N=y[0],g=y[1];N[28]=258,g[258]=28;for(var v=p(d,0),A=v[0],E=v[1],m=new l(32768),I=0;I<32768;++I){var S=(43690&I)>>>1|(21845&I)<<1;S=(61680&(S=(52428&S)>>>2|(13107&S)<<2))>>>4|(3855&S)<<4,m[I]=((65280&S)>>>8|(255&S)<<8)>>>1}var w=function(e,t,n){for(var r=e.length,a=0,i=new l(t);a<r;++a)e[a]&&++i[e[a]-1];var o,s=new l(t);for(a=0;a<t;++a)s[a]=s[a-1]+i[a-1]<<1;if(n){o=new l(1<<t);var c=15-t;for(a=0;a<r;++a)if(e[a])for(var u=a<<4|e[a],f=t-e[a],h=s[e[a]-1]++<<f,d=h|(1<<f)-1;h<=d;++h)o[m[h]>>>c]=u}else for(o=new l(r),a=0;a<r;++a)e[a]&&(o[a]=m[s[e[a]-1]++]>>>15-e[a]);return o},R=new u(288);for(I=0;I<144;++I)R[I]=8;for(I=144;I<256;++I)R[I]=9;for(I=256;I<280;++I)R[I]=7;for(I=280;I<288;++I)R[I]=8;var b=new u(32);for(I=0;I<32;++I)b[I]=5;var U=w(R,9,0),O=w(R,9,1),_=w(b,5,0),k=w(b,5,1),x=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},F=function(e,t,n){var r=t/8|0;return(e[r]|e[r+1]<<8)>>(7&t)&n},D=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},L=function(e){return(e+7)/8|0},C=function(e,t,n){(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length);var r=new(2==e.BYTES_PER_ELEMENT?l:4==e.BYTES_PER_ELEMENT?f:u)(n-t);return r.set(e.subarray(t,n)),r},B=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Y=function(e,t,n){var r=new Error(t||B[e]);if(r.code=e,Error.captureStackTrace&&Error.captureStackTrace(r,Y),!n)throw r;return r},z=function(e,t,n){n<<=7&t;var r=t/8|0;e[r]|=n,e[r+1]|=n>>>8},j=function(e,t,n){n<<=7&t;var r=t/8|0;e[r]|=n,e[r+1]|=n>>>8,e[r+2]|=n>>>16},P=function(e,t){for(var n=[],r=0;r<e.length;++r)e[r]&&n.push({s:r,f:e[r]});var a=n.length,i=n.slice();if(!a)return[X,0];if(1==a){var o=new u(n[0].s+1);return o[n[0].s]=1,[o,1]}n.sort((function(e,t){return e.f-t.f})),n.push({s:-1,f:25001});var s=n[0],c=n[1],f=0,h=1,d=2;for(n[0]={s:-1,f:s.f+c.f,l:s,r:c};h!=a-1;)s=n[n[f].f<n[d].f?f++:d++],c=n[f!=h&&n[f].f<n[d].f?f++:d++],n[h++]={s:-1,f:s.f+c.f,l:s,r:c};var T=i[0].s;for(r=1;r<a;++r)i[r].s>T&&(T=i[r].s);var p=new l(T+1),y=M(n[h-1],p,0);if(y>t){r=0;var N=0,g=y-t,v=1<<g;for(i.sort((function(e,t){return p[t.s]-p[e.s]||e.f-t.f}));r<a;++r){var A=i[r].s;if(!(p[A]>t))break;N+=v-(1<<y-p[A]),p[A]=t}for(N>>>=g;N>0;){var E=i[r].s;p[E]<t?N-=1<<t-p[E]++-1:++r}for(;r>=0&&N;--r){var m=i[r].s;p[m]==t&&(--p[m],++N)}y=t}return[new u(p),y]},M=function(e,t,n){return-1==e.s?Math.max(M(e.l,t,n+1),M(e.r,t,n+1)):t[e.s]=n},J=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new l(++t),r=0,a=e[0],i=1,o=function(e){n[r++]=e},s=1;s<=t;++s)if(e[s]==a&&s!=t)++i;else{if(!a&&i>2){for(;i>138;i-=138)o(32754);i>2&&(o(i>10?i-11<<5|28690:i-3<<5|12305),i=0)}else if(i>3){for(o(a),--i;i>6;i-=6)o(8304);i>2&&(o(i-3<<5|8208),i=0)}for(;i--;)o(a);i=1,a=e[s]}return[n.subarray(0,r),t]},V=function(e,t){for(var n=0,r=0;r<t.length;++r)n+=e[r]*t[r];return n},G=function(e,t,n){var r=n.length,a=L(t+2);e[a]=255&r,e[a+1]=r>>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var i=0;i<r;++i)e[a+i+4]=n[i];return 8*(a+4+r)},H=function(e,t,n,r,a,i,o,s,c,u,f){z(t,f++,n),++a[256];for(var p=P(a,15),y=p[0],N=p[1],g=P(i,15),v=g[0],A=g[1],E=J(y),m=E[0],I=E[1],S=J(v),O=S[0],k=S[1],x=new l(19),F=0;F<m.length;++F)x[31&m[F]]++;for(F=0;F<O.length;++F)x[31&O[F]]++;for(var D=P(x,7),L=D[0],C=D[1],B=19;B>4&&!L[T[B-1]];--B);var Y,M,H,$,X=u+5<<3,q=V(a,R)+V(i,b)+o,W=V(a,y)+V(i,v)+o+14+3*B+V(x,L)+(2*x[16]+3*x[17]+7*x[18]);if(X<=q&&X<=W)return G(t,f,e.subarray(c,c+u));if(z(t,f,1+(W<q)),f+=2,W<q){Y=w(y,N,0),M=y,H=w(v,A,0),$=v;var K=w(L,C,0);for(z(t,f,I-257),z(t,f+5,k-1),z(t,f+10,B-4),f+=14,F=0;F<B;++F)z(t,f+3*F,L[T[F]]);f+=3*B;for(var Q=[m,O],Z=0;Z<2;++Z){var ee=Q[Z];for(F=0;F<ee.length;++F){var te=31&ee[F];z(t,f,K[te]),f+=L[te],te>15&&(z(t,f,ee[F]>>>5&127),f+=ee[F]>>>12)}}}else Y=U,M=R,H=_,$=b;for(F=0;F<s;++F)if(r[F]>255){te=r[F]>>>18&31,j(t,f,Y[te+257]),f+=M[te+257],te>7&&(z(t,f,r[F]>>>23&31),f+=h[te]);var ne=31&r[F];j(t,f,H[ne]),f+=$[ne],ne>3&&(j(t,f,r[F]>>>5&8191),f+=d[ne])}else j(t,f,Y[r[F]]),f+=M[r[F]];return j(t,f,Y[256]),f+M[256]},$=new f([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),X=new u(0),q=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var n=t,r=9;--r;)n=(1&n&&-306674912)^n>>>1;e[t]=n}return e}(),W=function(e,t,n,r,a){return function(e,t,n,r,a,i){var o=e.length,s=new u(r+o+5*(1+Math.ceil(o/7e3))+a),c=s.subarray(r,s.length-a),T=0;if(!t||o<8)for(var p=0;p<=o;p+=65535){var y=p+65535;y>=o&&(c[T>>3]=i),T=G(c,T+1,e.subarray(p,y))}else{for(var N=$[t-1],v=N>>>13,A=8191&N,m=(1<<n)-1,I=new l(32768),S=new l(m+1),w=Math.ceil(n/3),R=2*w,b=function(t){return(e[t]^e[t+1]<<w^e[t+2]<<R)&m},U=new f(25e3),O=new l(288),_=new l(32),k=0,x=0,F=(p=0,0),D=0,B=0;p<o;++p){var Y=b(p),z=32767&p,j=S[Y];if(I[z]=j,S[Y]=z,D<=p){var P=o-p;if((k>7e3||F>24576)&&P>423){T=H(e,c,0,U,O,_,x,F,B,p-B,T),F=k=x=0,B=p;for(var M=0;M<286;++M)O[M]=0;for(M=0;M<30;++M)_[M]=0}var J=2,V=0,q=A,W=z-j&32767;if(P>2&&Y==b(p-W))for(var K=Math.min(v,P)-1,Q=Math.min(32767,p),Z=Math.min(258,P);W<=Q&&--q&&z!=j;){if(e[p+J]==e[p+J-W]){for(var ee=0;ee<Z&&e[p+ee]==e[p+ee-W];++ee);if(ee>J){if(J=ee,V=W,ee>K)break;var te=Math.min(W,ee-2),ne=0;for(M=0;M<te;++M){var re=p-W+M+32768&32767,ae=re-I[re]+32768&32767;ae>ne&&(ne=ae,j=re)}}}W+=(z=j)-(j=I[z])+32768&32767}if(V){U[F++]=268435456|g[J]<<18|E[V];var ie=31&g[J],oe=31&E[V];x+=h[ie]+d[oe],++O[257+ie],++_[oe],D=p+J,++k}else U[F++]=e[p],++O[e[p]]}}T=H(e,c,i,U,O,_,x,F,B,p-B,T),!i&&7&T&&(T=G(c,T+1,X))}return C(s,0,r+L(T)+a)}(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,n,r,!a)},K=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8};function Q(e,t){t||(t={});var n=function(){var e=-1;return{p:function(t){for(var n=e,r=0;r<t.length;++r)n=q[255&n^t[r]]^n>>>8;e=n},d:function(){return~e}}}(),r=e.length;n.p(e);var a,i=W(e,t,10+((a=t).filename&&a.filename.length+1||0),8),o=i.length;return function(e,t){var n=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&K(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),n){e[3]=8;for(var r=0;r<=n.length;++r)e[r+10]=n.charCodeAt(r)}}(i,t),K(i,o-8,n.d()),K(i,o-4,r),i}function Z(e,t){return function(e,t,n){var r=e.length;if(!r||n&&n.f&&!n.l)return t||new u(0);var a=!t||n,i=!n||n.i;n||(n={}),t||(t=new u(3*r));var o=function(e){var n=t.length;if(e>n){var r=new u(Math.max(2*n,e));r.set(t),t=r}},s=n.f||0,c=n.p||0,l=n.b||0,f=n.l,p=n.d,y=n.m,g=n.n,v=8*r;do{if(!f){s=F(e,c,1);var E=F(e,c+1,3);if(c+=3,!E){var m=e[(M=L(c)+4)-4]|e[M-3]<<8,I=M+m;if(I>r){i&&Y(0);break}a&&o(l+m),t.set(e.subarray(M,I),l),n.b=l+=m,n.p=c=8*I,n.f=s;continue}if(1==E)f=O,p=k,y=9,g=5;else if(2==E){var S=F(e,c,31)+257,R=F(e,c+10,15)+4,b=S+F(e,c+5,31)+1;c+=14;for(var U=new u(b),_=new u(19),B=0;B<R;++B)_[T[B]]=F(e,c+3*B,7);c+=3*R;var z=x(_),j=(1<<z)-1,P=w(_,z,1);for(B=0;B<b;){var M,J=P[F(e,c,j)];if(c+=15&J,(M=J>>>4)<16)U[B++]=M;else{var V=0,G=0;for(16==M?(G=3+F(e,c,3),c+=2,V=U[B-1]):17==M?(G=3+F(e,c,7),c+=3):18==M&&(G=11+F(e,c,127),c+=7);G--;)U[B++]=V}}var H=U.subarray(0,S),$=U.subarray(S);y=x(H),g=x($),f=w(H,y,1),p=w($,g,1)}else Y(1);if(c>v){i&&Y(0);break}}a&&o(l+131072);for(var X=(1<<y)-1,q=(1<<g)-1,W=c;;W=c){var K=(V=f[D(e,c)&X])>>>4;if((c+=15&V)>v){i&&Y(0);break}if(V||Y(2),K<256)t[l++]=K;else{if(256==K){W=c,f=null;break}var Q=K-254;if(K>264){var Z=h[B=K-257];Q=F(e,c,(1<<Z)-1)+N[B],c+=Z}var ee=p[D(e,c)&q],te=ee>>>4;if(ee||Y(3),c+=15&ee,$=A[te],te>3&&(Z=d[te],$+=D(e,c)&(1<<Z)-1,c+=Z),c>v){i&&Y(0);break}a&&o(l+131072);for(var ne=l+Q;l<ne;l+=4)t[l]=t[l-$],t[l+1]=t[l+1-$],t[l+2]=t[l+2-$],t[l+3]=t[l+3-$];l=ne}}n.l=f,n.p=W,n.b=l,n.f=s,f&&(s=1,n.m=y,n.d=p,n.n=g)}while(!s);return l==t.length?t:C(t,0,l)}(e.subarray(function(e){31==e[0]&&139==e[1]&&8==e[2]||Y(6,"invalid gzip data");var t=e[3],n=10;4&t&&(n+=e[10]|2+(e[11]<<8));for(var r=(t>>3&1)+(t>>4&1);r>0;r-=!e[n++]);return n+(2&t)}(e),-8),t||new u((r=(n=e).length,(n[r-4]|n[r-3]<<8|n[r-2]<<16|n[r-1]<<24)>>>0)));var n,r}var ee="undefined"!=typeof TextDecoder&&new TextDecoder;try{ee.decode(X,{stream:!0})}catch(e){}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;class te{encode(e){return Q(new Uint8Array(e)).buffer}decode(e){return Z(new Uint8Array(e)).buffer}}const ne="1.0.25",re=/\W+/g,ae=/(\w{3,}\W+){2,}|(\W+\w{3,}){2,}/;function ie(e){return Array.isArray(e)?"array":"object"==typeof e&&e?"object":"string"==typeof e&&new Set(e).size<16?"leaf":"string"==typeof e&&ae.test(e)?"split":"leaf"}var oe=n(560),se=n.n(oe);class ce{constructor(){this.loader=new e}load(...e){return t=this,n=void 0,a=function*(){if(e.some((e=>"string"!=typeof e)))throw new Error("Each argument passed to load must be a string.");const t=e.sort(),n=yield Promise.all(t.map(this.loader.load)),r=this.tokenize(Object.fromEntries(n.map(((e,n)=>[t[n],e])))),a=new TextEncoder;return r.originalDataSize=a.encode(JSON.stringify(n)).byteLength,r},new((r=void 0)||(r=Promise))((function(e,i){function o(e){try{c(a.next(e))}catch(e){i(e)}}function s(e){try{c(a.throw(e))}catch(e){i(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(o,s)}c((a=a.apply(t,n||[])).next())}));var t,n,r,a}tokenize(e){const t={registry:{},files:{}},n={next:0};return Object.entries(e).forEach((([e,r])=>{t.files[e]={nameToken:this.tokenizeHelper(e,t.registry,n,"header"),token:this.tokenizeHelper(r,t.registry,n,e)}})),t}registerToken(e,t,n,r,a,i){var o;const s=null!==(o=n[e])&&void 0!==o?o:n[e]={type:ie(t),hash:e,value:t,reference:i,order:r.next++,count:0,files:new Set};return s.files.add(a),s.count++,s}tokenizeHelper(e,t,n,r){const a=ie(e);if("array"===a){if(!Array.isArray(e))throw new Error("item should be an array");const a=e.map((e=>this.tokenizeHelper(e,t,n,r))).map((({hash:e})=>e)),i=se()(a.join(","));return this.registerToken(i,e,t,n,r,a)}if("object"===a){const a=Object.entries(e),i=this.tokenizeHelper(a.map((([e])=>e)),t,n,r),o=this.tokenizeHelper(a.map((([,e])=>e)),t,n,r),s=se()(`${i.hash}|${o.hash}`);return this.registerToken(s,e,t,n,r,[i.hash,o.hash])}if("split"===a){const a=e.split(re),i=e.match(re),o=this.tokenizeHelper(a,t,n,r),s=this.tokenizeHelper(i,t,n,r),c=se()(`${o.hash}-${s.hash}`);return this.registerToken(c,e,t,n,r,[o.hash,s.hash])}{const a=se()(JSON.stringify(e));return this.registerToken(a,e,t,n,r)}}}const ue={cacheable:!0};class le{constructor(e,t){this.extractor=new fe,this.dataStore=e,this.config=Object.assign(Object.assign({},ue),t),this.fileNames=this.extractor.extractFileNames(e.files,e.headerTokens,this.config),this.fileToSlot=Object.fromEntries(this.fileNames.map(((e,t)=>[e,t]))),this.version=e.version,this.originalDataSize=e.originalDataSize,this.compressedSize=e.compressedSize}extract(e){const t=this.fileToSlot[e],n=this.dataStore.getDataTokens(t);if(n)return this.extractor.extract(this.dataStore.headerTokens,n,this.config)}getHeaderTokens(){return this.dataStore.headerTokens}}class fe{constructor(){this.valueFetcher={array:this.getArray.bind(this),leaf:this.getLeaf.bind(this),object:this.getObject.bind(this),split:this.getSplit.bind(this),reference:this.getReference.bind(this),complex:void 0}}extractFileNames(e,t,n){return e.map((e=>this.extractToken(e,t,void 0,n)))}extract(e,t,n){const r=t.entries(),[,a]=r.next().value,i=a.value;return this.extractComplex(i.entries(),r,e,[...t],n)}extractComplex(e,n,r,a,i){const[,o]=e.next().value;switch(o){case t.LEAF:const[,o]=n.next().value;return this.extractValueOrCache(o,r,a,i,!0,this.valueFetcher[o.type]);case t.ARRAY:const[,s]=n.next().value;return new Array(s.value).fill(null).map((t=>this.extractComplex(e,n,r,a,i)));case t.OBJECT:const c=this.extractComplex(e,n,r,a,i),u=this.extractComplex(e,n,r,a,i);return Object.fromEntries(c.map(((e,t)=>[e,u[t]])));case t.SPLIT:const l=this.extractComplex(e,n,r,a,i),f=this.extractComplex(e,n,r,a,i),h=l.map(((e,t)=>{var n;return`${e}${null!==(n=f[t])&&void 0!==n?n:""}`})).join("");return h}}extractToken(e,t,n,r,a){const i=e<t.length?t[e]:null==n?void 0:n[e-t.length];if(!i)throw new Error("Invalid token at index: "+e);return this.extractValueOrCache(i,t,n,r,a,this.valueFetcher[i.type])}getLeaf(e){return e.value}getReference(e,t,n,r){const a=e.value;return this.extractToken(a,t,n,r)}getArray(e,t,n,r){if(!Array.isArray(e.value))throw new Error("Invalid array token");return e.value.map((e=>this.extractToken(e,t,n,r)))}getObject(e,t,n,r){const[a,i]=e.value,o=this.extractToken(a,t,n,r,!0),s=this.extractToken(i,t,n,r);return Object.fromEntries(o.map(((e,t)=>[e,s[t]])))}getSplit(e,t,n,r){const[a,i]=e.value,o=this.extractToken(a,t,n,r,!0),s=this.extractToken(i,t,n,r,!0);return o.map(((e,t)=>{var n;return`${e}${null!==(n=s[t])&&void 0!==n?n:""}`})).join("")}extractValueOrCache(e,t,n,r,a,i){if(void 0!==e.cache&&a)return e.cache;const o=i(e,t,n,r);return r.cacheable&&"leaf"!==e.type&&(e.cache=o),o}}var he,de=function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,s)}c((r=r.apply(e,t||[])).next())}))};!function(e){e[e.NONE=0]="NONE",e[e.FFLATE=1]="FFLATE"}(he||(he={}));const Te=[()=>{},()=>new te],pe=[he.FFLATE],ye={Loader:e,Compressor:class{constructor(e){this.allowSet=e}applyEncoders(e,t){let n=e;return t.forEach((e=>{n=e.encode(n)})),n}applyDecoders(e,t){let n=e;return t.forEach((e=>{n=e.decode(n)})),n}loadAndCompress(e){return de(this,void 0,void 0,(function*(){const t=new ce,n=yield t.load(...e),r=new c(this.allowSet).reduce(n);return this.compressDataStore(r)}))}compress(e){const t=(new ce).tokenize(e),n=new c(this.allowSet).reduce(t);return this.compressDataStore(n)}loadAndExpand(e){return de(this,void 0,void 0,(function*(){const t=yield fetch(e),n=yield t.arrayBuffer();return this.expand(n)}))}expand(e,t){return new le(this.expandDataStore(e),t)}compressDataStore(e,t=pe){var n;const r=new a.StreamDataView,i=new s(r,this.allowSet);i.encodeTokens(e.headerTokens,!0),i.encodeNumberArray(e.files);const o=new a.StreamDataView;o.setNextUint8(ne.length),o.setNextString(ne),t.forEach((e=>o.setNextUint8(e))),o.setNextUint8(0);const c=t.map((e=>Te[e]())).filter((e=>!!e)),u=this.applyEncoders(r.getBuffer(),c);o.setNextUint32(u.byteLength),o.setNextBytes(u),console.log("HEADER length",u.byteLength);for(let t=0;t<e.files.length;t++){const n=new a.StreamDataView;new s(n,this.allowSet).encodeTokens(e.getDataTokens(t),!1);const r=this.applyEncoders(n.getBuffer(),c);o.setNextUint32(r.byteLength),console.log("SUBBUFFER length",t,r.byteLength),o.setNextBytes(r)}return o.setNextUint32(0),o.setNextUint32(null!==(n=e.originalDataSize)&&void 0!==n?n:0),o.getBuffer()}expandDataStore(e){const t=e.byteLength;let n=e;const r=new a.StreamDataView(n),i=r.getNextString(r.getNextUint8()),o=[];do{const e=r.getNextUint8();if(e===he.NONE)break;const t=Te[e]();t&&o.push(t)}while(r.getOffset()<r.getLength());const c=r.getNextUint32(),u=this.applyDecoders(r.getNextBytes(c).buffer,o),l=new s(new a.StreamDataView(u),this.allowSet),f=l.decodeTokens(!0),h=l.decodeNumberArray(),d=[];do{const e=r.getNextUint32();if(!e)break;d.push(r.getNextBytes(e).buffer)}while(r.getOffset()<r.getLength());let T;try{T=r.getNextUint32()||void 0}catch(e){}return{version:i,originalDataSize:T,compressedSize:t,headerTokens:f,files:h,getDataTokens:e=>{const t=this.applyDecoders(d[e],o),n=new a.StreamDataView(t);return new s(n,this.allowSet).decodeTokens(!1)}}}},TokenEncoder:s};globalThis.exports=ye})()})();
//# sourceMappingURL=main.js.map