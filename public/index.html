<html lang="en">
	<head>
    <meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="gen/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const div = document.createElement("div");
        div.style.position = "fixed";
        div.style.bottom = "0px";
        div.style.left = "0px";
        div.style.backgroundColor = "silver";
        div.style.width = "100vw";
        div.style.padding = "5px";
        div.style.margin = "0px";
        div.style.opacity = ".8";
        div.style.cursor = "pointer";
        div.addEventListener("mousedown", () => document.body.removeChild(div));
        div.innerText = `âœ– Exports: ${Object.keys(exports).join(", ")}`;
        document.body.appendChild(div);
      });
    </script>
    <title>Demo</title>
	</head>
	<body>
    <script>
      const out = document.body.appendChild(
         document.createElement("div"));
      out.style.whiteSpace = "pre";
      console.log = (...msg) => out.textContent += msg.map(m => JSON.stringify(m, null, "  ")).join(" ") + "\n";


      document.addEventListener("DOMContentLoaded", async () => {
        const { Tokenizer, Reducer, ExtractableData, Loader } = exports;
        const files = [
          "data/data-1.json",
          "data/data-2.json",
          "data/data-3.json",
          "data/data-4.json",
          "data/data-5.json",
          "data/data-repeat-object.json",
          "data/data-text.txt",
        ].sort();

        const loader = new Loader();
        const originalData = await Promise.all(files.map(loader.load));

        const tokenizer = new Tokenizer();
        const header = await tokenizer.load(...files);

        const reducer = new Reducer();
        const dataStore = reducer.reduce(header);

        const extractable = new ExtractableData(dataStore, {allowReferences: true});

        files.forEach((file, index) => {
          const extractedData = extractable.extract(file);
          console.log(file, extractedData);
          console.assert(JSON.stringify(originalData[index]) === JSON.stringify(extractedData));
        });
        window.extractable = extractable;

        const repeatObject = extractable.extract("data/data-repeat-object.json");
        console.assert(repeatObject.a === repeatObject.b);

        const repeatObjectNoReference = extractable.extract("data/data-repeat-object.json", false);
        console.assert(repeatObjectNoReference.a !== repeatObjectNoReference.b);
      });
    </script>
	</body>
</html>
